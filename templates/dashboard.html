<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Dashboard - E-Forms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        .modal { transition: opacity 0.3s ease; }
        .hidden { display: none; } 
        /* Animation for fading out flash messages */
        .fade-out { opacity: 0; transition: opacity 0.5s ease; }
    </style>
</head>
<body class="bg-[#f9f4ff] font-['Montserrat'] min-h-screen pb-10">

    <header class="w-full bg-[#8e44ad] p-4 flex justify-between items-center shadow-md sticky top-0 z-50">
       <div class="text-[#8e44ad] text-2xl font-bold bg-white w-10 h-10 flex items-center justify-center rounded-lg">P</div> 
        <div class="flex items-center gap-4">
            <span class="text-white font-semibold hidden sm:block">Welcome, {{ current_user.username }}</span>
            <a href="{{ url_for('logout') }}" class="bg-white text-[#8e44ad] px-4 py-2 rounded-lg font-bold hover:bg-gray-100 transition">Logout</a>
        </div>
    </header>

    <div class="max-w-5xl mx-auto p-6">
        
        <div id="flash-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-msg mb-4 p-4 rounded-lg shadow-md font-bold text-white
                            {% if category == 'error' %} bg-red-500 {% else %} bg-green-500 {% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 text-center border border-gray-100">
            <h2 class="text-[#8e44ad] text-2xl font-bold mb-2">Create a New Survey</h2>
            <p class="text-gray-500 mb-6 text-sm">Upload your .xlsx or .csv file to generate a form instantly.</p>
            
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="flex flex-col items-center gap-4">
                <div class="relative w-full max-w-sm">
                    <input type="file" name="surveyFile" accept=".csv, .xlsx" required class="block w-full text-sm text-slate-500
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-full file:border-0
                      file:text-sm file:font-semibold
                      file:bg-[#f3e5f5] file:text-[#8e44ad]
                      hover:file:bg-[#e1bee7] cursor-pointer border border-gray-200 rounded-full"/>
                </div>
                
                <div class="flex gap-3 w-full max-w-sm">
                    <button type="submit" class="flex-1 bg-[#8e44ad] text-white px-6 py-2.5 rounded-xl font-bold shadow-md hover:bg-[#7d3c98] transition flex items-center justify-center gap-2">
                        <i class="fa fa-cloud-upload"></i> Upload
                    </button>
                    <button type="button" onclick="toggleTemplate()" class="flex-1 bg-gray-100 text-gray-600 px-6 py-2.5 rounded-xl font-bold shadow-sm hover:bg-gray-200 transition flex items-center justify-center gap-2">
                        <i class="fa fa-file-excel-o"></i> Template
                    </button>
                </div>
            </form>

            <div id="templatePreview" class="hidden mt-6 bg-[#f3e5f5] p-4 rounded-xl border-2 border-dashed border-[#ce93d8]">
                <h4 class="text-[#8e44ad] font-bold mb-2">Excel Format Example</h4>
                <p class="text-sm text-gray-600 mb-4">Row 1: Questions | Row 2: Input Types (text, date, select)</p>
                <img src="{{ url_for('static', filename='excel-template.png') }}" 
                     onerror="this.src='https://image2url.com/images/1759919487163-80129482-aa7b-4b8d-96ba-69274deace13.png'"
                     alt="Excel Template Example" class="w-full h-auto rounded-lg shadow-sm border border-gray-200">
                <button onclick="toggleTemplate()" class="mt-4 text-sm text-gray-500 underline hover:text-[#8e44ad]">Close Preview</button>
            </div>
        </div>

        <h3 class="text-[#4a148c] text-xl font-bold mb-6 border-l-4 border-[#ce93d8] pl-3">Your Surveys</h3>
        
        {% if surveys %}
            <div class="grid gap-5">
            {% for survey in surveys %}
                {% set survey_link = url_for('show_survey', survey_id=survey.survey_uuid, _external=True) %}
                
                <div class="bg-white p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    
                    <div>
                        <h4 class="font-bold text-lg text-gray-800">{{ survey.original_name }}</h4>
                        <div class="flex items-center gap-3 text-sm text-gray-500 mt-1">
                            <span><i class="fa fa-calendar mr-1"></i> {{ survey.created_at.strftime('%b %d, %Y') }}</span>
                            <span class="text-gray-300">|</span>
                            <a href="{{ survey_link }}" target="_blank" class="text-blue-500 hover:underline">Open Form ↗</a>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 w-full md:w-auto items-center">
                        <button type="button" onclick="robustCopy('{{ survey_link }}')" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200 transition text-sm flex items-center gap-2" title="Copy Link">
                            <i class="fa fa-link"></i> Copy
                        </button>

                        <button type="button" onclick="openShareModal('{{ survey_link }}')" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-100 transition text-sm flex items-center gap-2" title="Share">
                            <i class="fa fa-share-alt"></i> Share
                        </button>

                        <a href="{{ url_for('download_responses', survey_id=survey.survey_uuid) }}" class="bg-green-50 text-green-600 px-4 py-2 rounded-lg font-semibold hover:bg-green-100 transition text-sm flex items-center gap-2" title="Download Excel">
                            <i class="fa fa-download"></i> Data
                        </a>

                        <form action="{{ url_for('delete_survey', survey_id=survey.survey_uuid) }}" method="POST" onsubmit="return confirm('⚠️ Are you sure you want to delete this survey?\n\nThis will permanently delete:\n- The survey form\n- All collected responses\n\nThis action cannot be undone.');">
                            <button type="submit" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-semibold hover:bg-red-100 transition text-sm flex items-center gap-2" title="Delete Survey">
                                <i class="fa fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16 bg-white rounded-xl shadow-sm border border-gray-100">
                <i class="fa fa-folder-open-o text-4xl text-gray-300 mb-2"></i>
                <p class="text-gray-500">No surveys found. Upload a file to start!</p>
            </div>
        {% endif %}
    </div>

    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl mx-4 relative">
            <button onclick="closeShareModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa fa-times text-xl"></i>
            </button>
            <h3 class="text-xl font-bold text-[#8e44ad] mb-1">Share Survey</h3>
            <p class="text-sm text-gray-500 mb-6">Choose how you want to share this form.</p>
            <input type="hidden" id="modalLinkInput">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <a id="whatsappBtn" href="#" target="_blank" class="flex items-center justify-center gap-2 bg-green-50 text-green-600 py-3 rounded-xl hover:bg-green-100 transition font-bold border border-green-200">
                    <i class="fa fa-whatsapp text-xl"></i> WhatsApp
                </a>
                <button onclick="copyFromModal()" class="flex items-center justify-center gap-2 bg-gray-50 text-gray-700 py-3 rounded-xl hover:bg-gray-100 transition font-bold border border-gray-200">
                    <i class="fa fa-copy text-xl"></i> Copy Link
                </button>
            </div>
            <div class="border-t pt-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Or send via Email</label>
                <div class="flex gap-2">
                    <input type="email" id="modalEmailInput" placeholder="recipient@email.com" class="flex-1 p-3 border border-gray-300 rounded-lg focus:border-[#8e44ad] focus:outline-none">
                    <button onclick="sendEmail()" class="bg-[#8e44ad] text-white px-4 rounded-lg hover:bg-[#7d3c98] transition">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='admin_script.js') }}"></script>

</body>
</html>